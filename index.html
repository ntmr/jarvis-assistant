<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ì–æ–ª–æ—Å–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ö–æ—Ç</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #222; color: #eee; }
    #chat { max-width: 600px; margin: auto; padding: 10px; }
    .message { padding: 8px; margin: 6px 0; border-radius: 6px; max-width: 80%; }
    .assistant { background: #444; text-align: left; }
    .user { background: #0084ff; text-align: right; margin-left: auto; }
    #micBtn { font-size: 24px; padding: 10px 20px; cursor: pointer; }
    #muteBtn { position: fixed; top: 10px; right: 10px; cursor: pointer; background: #444; border: none; color: white; padding: 6px 12px; border-radius: 4px; }
  </style>
</head>
<body>

<div id="chat"></div>
<button id="micBtn">üé§ –ì–æ–≤–æ—Ä–∏—Ç—å</button>
<button id="muteBtn">üîä –í–∫–ª/–í—ã–∫–ª –∑–≤—É–∫</button>

<script>
  const chat = document.getElementById('chat');
  const micBtn = document.getElementById('micBtn');
  const muteBtn = document.getElementById('muteBtn');

  let isMuted = false;
  let recognition;
  let speechSynthesisUtterance;

  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏');
  } else {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'ru-RU';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = async (event) => {
      const text = event.results[0][0].transcript;
      addMessage(text, 'user');
      await sendToAssistant(text);
    };

    recognition.onerror = (event) => {
      console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏:', event.error);
    };
  }

  micBtn.onclick = () => {
    try {
      recognition.start();
    } catch (e) {
      console.error('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–æ');
    }
  };

  muteBtn.onclick = () => {
    isMuted = !isMuted;
    muteBtn.textContent = isMuted ? 'üîá –ó–≤—É–∫ –≤—ã–∫–ª—é—á–µ–Ω' : 'üîä –ó–≤—É–∫ –≤–∫–ª—é—á–µ–Ω';
  };

  function addMessage(text, role) {
    const div = document.createElement('div');
    div.textContent = text;
    div.className = `message ${role}`;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  async function sendToAssistant(text) {
    addMessage('...', 'assistant');
    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: "GigaChat:latest",
          messages: [
            { role: "system", content: "–¢—ã –≥–æ–ª–æ—Å–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –∏–º–µ–Ω–∏ –ö–æ—Ç. –ì–æ–≤–æ—Ä–∏ –∫–æ—Ä–æ—Ç–∫–æ –∏ —è—Å–Ω–æ." },
            { role: "user", content: text }
          ],
          temperature: 0.7,
        })
      });

      const text = await res.text();
      console.log('–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', text);
      const data = JSON.parse(text);
      
      if (data.choices && data.choices[0] && data.choices[0].message) {
        const reply = data.choices[0].message.content;
        chat.lastChild.textContent = reply;

        if (!isMuted) {
          speechSynthesis.cancel();
          speechSynthesisUtterance = new SpeechSynthesisUtterance(reply);
          speechSynthesisUtterance.lang = 'ru-RU';
          speechSynthesis.speak(speechSynthesisUtterance);
        }
      } else {
        chat.lastChild.textContent = '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–µ –¥–∞–ª –æ—Ç–≤–µ—Ç–∞';
      }

    } catch (e) {
      chat.lastChild.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É';
      console.error(e);
    }
  }
</script>

</body>
</html>
